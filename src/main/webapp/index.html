<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 800px; width: 100%; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .auth-form { display: flex; flex-direction: column; gap: 10px; max-width: 300px; margin: 0 auto; }
        .auth-form input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .auth-form button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .auth-form button:hover { background: #0056b3; }
        h2 { margin-bottom: 20px; text-align: center; }
        .chat-container { display: none; }
        .users-list { border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .user-item { padding: 8px; cursor: pointer; border-radius: 4px; }
        .user-item:hover { background: #f0f0f0; }
        .user-item.active { background: #007bff; color: white; }
        .messages { height: 400px; border: 1px solid #ddd; padding: 10px; overflow-y: scroll; margin-bottom: 10px; border-radius: 4px; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .message.sent { background: #007bff; color: white; text-align: right; }
        .message.received { background: #e9ecef; }
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .input-area button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
            <h2>Login</h2>
            <div class="auth-form">
                <input type="text" id="login-username" placeholder="Username">
                <input type="password" id="login-password" placeholder="Password">
                <button onclick="login()">Login</button>
            </div>
            <h2>Register</h2>
            <div class="auth-form">
                <input type="text" id="register-username" placeholder="Username">
                <input type="password" id="register-password" placeholder="Password">
                <button onclick="register()">Register</button>
            </div>
        </div>

        <div id="chat-container" class="chat-container">
            <h2>Chat - <span id="current-user"></span></h2>
            <div class="users-list">
                <h3>Users</h3>
                <div id="users"></div>
            </div>
            <div id="messages" class="messages"></div>
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let currentUser = null;
        let selectedUserId = null;
        let messageHistory = {};

        async function register() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;

            const response = await fetch('/chat/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });

            if (response.ok) {
                alert('Registration successful! Please login.');
            } else {
                alert('Registration failed');
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const response = await fetch('/chat/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });

            if (response.ok) {
                currentUser = await response.json();
                document.getElementById('current-user').textContent = currentUser.username;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('chat-container').style.display = 'block';
                connectWebSocket();
                loadUsers();
            } else {
                alert('Login failed');
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + window.location.host + '/chat/chat');

            ws.onopen = function() {
                ws.send(JSON.stringify({
                    type: 'auth',
                    userId: currentUser.id
                }));
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'message') {
                    const key = data.fromUserId;
                    if (!messageHistory[key]) {
                        messageHistory[key] = [];
                    }
                    messageHistory[key].push({
                        from: data.fromUserId,
                        content: data.content
                    });
                    if (selectedUserId == data.fromUserId) {
                        displayMessages();
                    }
                }
            };
        }

        async function loadUsers() {
            const response = await fetch('/chat/api/users');
            const users = await response.json();

            const usersDiv = document.getElementById('users');
            usersDiv.innerHTML = '';
            users.forEach(user => {
                if (user.id !== currentUser.id) {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.textContent = user.username;
                    div.onclick = () => selectUser(user.id);
                    usersDiv.appendChild(div);
                }
            });
        }

        function selectUser(userId) {
            selectedUserId = userId;
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            displayMessages();
        }

        function displayMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            const messages = messageHistory[selectedUserId] || [];
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message ' + (msg.from === currentUser.id ? 'sent' : 'received');
                div.textContent = msg.content;
                messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            if (!selectedUserId) {
                alert('Please select a user');
                return;
            }

            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content) return;

            ws.send(JSON.stringify({
                type: 'message',
                toUserId: selectedUserId,
                content: content
            }));

            if (!messageHistory[selectedUserId]) {
                messageHistory[selectedUserId] = [];
            }
            messageHistory[selectedUserId].push({
                from: currentUser.id,
                content: content
            });

            displayMessages();
            input.value = '';
        }

        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
